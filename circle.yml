machine:
  services:
    - docker

dependencies:
  override:
    - echo "No dependencies."

test:
  override:
    - echo "No tests."

#
# The builds at registry.hub.docker.com are awfully slow. Building at CI and
# pushing to the registry.
#
deployment:
  production:
    branch: master
    owner: andresriancho
    commands:
      #
      # Build the docker image and upload it to the registry
      #
      - docker build -t andresriancho/django-uwsgi-nginx-ssh-fat:${CIRCLE_SHA1:0:7}-production .

      # Push the new image to docker registry
      - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < docker/dockercfg.template > ~/.dockercfg
      - docker tag andresriancho/django-uwsgi-nginx-ssh-fat:${CIRCLE_SHA1:0:7}-production andresriancho/django-uwsgi-nginx-ssh-fat:production
      - docker push andresriancho/django-uwsgi-nginx-ssh-fat:${CIRCLE_SHA1:0:7}-production

  staging:
    branch: develop
    owner: andresriancho
    commands:
      #
      # Build the docker image and upload it to the registry
      #
      - docker build -t andresriancho/django-uwsgi-nginx-ssh-fat:${CIRCLE_SHA1:0:7}-staging .

      # Push the new image to docker registry
      - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < docker/dockercfg.template > ~/.dockercfg
      - docker tag andresriancho/django-uwsgi-nginx-ssh-fat:${CIRCLE_SHA1:0:7}-staging andresriancho/django-uwsgi-nginx-ssh-fat:staging
      - docker push andresriancho/django-uwsgi-nginx-ssh-fat:${CIRCLE_SHA1:0:7}-staging
